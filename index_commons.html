
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">

<meta name="author" content="" />
<!--<meta name="copyright" content="" />-->

<link rel="stylesheet" type="text/css" href="~commons/libs/font-awesome/css/font-awesome.min.css">     
<link rel="stylesheet" type="text/css" href="~commons/styles/index.css"> 
<link rel="stylesheet" type="text/css" href="~commons/styles/index_big_screen.css"> 

<!--settings first -> injects in language files-->
<script type="text/javascript" src="settings.js"></script> 

<!--        <script type="text/javascript" src="~commons/libs/jquery-1.11.0.min.js"></script>-->
<script type="text/javascript" src="~commons/libs/jquery.mobile.events.min.js"></script>
<script type="text/javascript" src="~commons/libs/modernizr-touch.js"></script>

<script type="text/javascript" src="~commons/votation/votationEvents.js"></script>
<script type="text/javascript" src="~commons/votation/ShareIntent.js"></script>
<script type="text/javascript" src="~commons/votation/VotationButtons.js"></script>
<script type="text/javascript" src="~commons/votation/newVotation.js"></script>  
<script type="text/javascript" src="~commons/votation/LoadKeyPoll.js"></script>        
<script type="text/javascript" src="~commons/votation/saveVotation.js"></script>

<script type="text/javascript" src="~commons/js/User.js"></script>
<script type="text/javascript" src="~commons/js/StoredPolls.js"></script>
<script type="text/javascript" src="~commons/js/HashManager.js"></script>
<script type="text/javascript" src="~commons/js/utils.js"></script>
<script type="text/javascript" src="~commons/js/parse.js"></script>

<script type="text/javascript" src="~commons/libs/wrapText.js"></script>

<script type="text/javascript" src="~commons/js/interface.js"></script>
<script type="text/javascript" src="~commons/js/events.js"></script>

<script type="text/javascript" src="~commons/getCountryName.js"></script>

<script src="~commons/libs/overthrow/overthrow-detect.js"></script>
<script src="~commons/libs/overthrow/overthrow-init.js"></script>
<script src="~commons/libs/overthrow/overthrow-polyfill.js"></script>
<script src="~commons/libs/overthrow/overthrow-toss.js"></script>

<script>

    //before js imports
    window.LoadedPoll = function () {
        console.log("new LoadedPoll");
        var _this = this;
        this.key = null;
        this.realKey = null;
        this.public = "";
        this.country = "";
        this.json = "";
        this.obj = {};
        //this.style = $.extend({}, defaultStyle);

        this.isPublic = function (value) {
            console.log("isPublic " + value + " : " + this.key);
            //value assign
            if (true === value) {
                if (window.p) {
                    p.activePublic();
                }
            } else if (false === value) {
                if (window.p) {
                    p.deactivePublic();
                }
                //ask
            } else {
                if ("-" == value[0]) {
                    _this.public = "";
                } else {
                    _this.public = "true";
                }
            }
            _this.public = value;
            return _this.public;
        };
    };
    window.screenPoll = new LoadedPoll();

    ////////////////////////////////////////////////////////////////////            

    // INIT GLOBALS
    window.localhost = document.location.hostname == "localhost";
    window.hashManager = new HashManager();

    //INIT CLASSES:
    if (!window.Device) {
        window.shareIntent = new ShareIntent();
    }

    //window.Device
    if (!window.Device) {
        window.Device = false;
//        $.getScript("~commons/browserStart.js");
        var ua = navigator.userAgent.toLowerCase();
        window.isAndroid = ua.indexOf("android") > -1; //&& ua.indexOf("mobile");
        window.iPhone = ua.indexOf("iPhone") > -1 || ua.indexOf("iPod") > -1;

    } else {
        $("html").addClass("Device");
    }

    //window.fromDeviceTranslucent
    if (Device.isTranslucent) {
        window.fromDeviceTranslucent = Device.isTranslucent();
        console.log("fromDeviceTranslucent? = " + window.fromDeviceTranslucent + "; location.hash: " + location.hash);
    }

    //window.isTranslucent
    if (location.hash == "#translucent" || window.fromDeviceTranslucent) {
        console.log("is translucent");
        window.isTranslucent = true;
        $('html').addClass('translucent');

        $("html").click(function (e) {
            if (e.target.nodeName == "HTML") {
                if (Device.close) {
                    Device.close("e.target.nodeName == HTML");
                }
            }
        });
    }

    // SCREEN POLL KEY HANDLE
    (function () {
        //if (location.pathname.match(/\//g).length == 1 && location.pathname.length > 1) { //not work with complex debugging subdomain
        if (location.pathname.match(/\//g).length > 0 && location.pathname.length > 1 && location.href.indexOf("/share") == -1) {
            var key = location.pathname.split("/").pop();
            if (key.indexOf('.') === -1) {
                screenPoll.key = key;
                console.log("KEY = " + screenPoll.key)
                //from app
            }
        }
        //deprecated?
        if (!screenPoll.key && location.search) { //before the ?
            screenPoll.key = location.search.substr(1);
            console.log("before the ? KEY = " + screenPoll.key);
        }

        if (screenPoll.key && !location.hash) {
            //header could be Twitter header webview
            $("html").addClass("withoutHeader");
            window.keyLinkPage = true;
        }
    })();

    // ON DOCUMENT READY:
    $(document).ready(function () {
        console.log("principal document ready");

        if (!window.user) { //if already from device
            console.log("add first window.user")
            window.user = new User(null, function () {
                //get userName not Device way (before any return)
                var userName = localStorage.getItem("userName");
                if (userName) {
                    $("#username input").val(userName);
                }
                keyLoad();
            });
        } else {
            keyLoad();
        }

        translateTags();
    });

    // GLOBAL FUNCTIONS

    //user init needed!
    function keyLoad() {
        if (screenPoll.key) {
            window.keyPoll = new LoadKeyPoll(screenPoll);
        }
    }

    function reset() {
        console.log("reset");
        resetData();
        hashManager.defaultPage();
        hashManager.resume();
    }

    function resetData() {
        console.log("resetData newUser");
        window.user = new User();
        screenPoll = new LoadedPoll();
    }

    //device function!
    function loading() {
        console.log("loading");
        $("#mainPage > div").hide();
        $("#loading").show();
    }

    //device function! (preload key only)
    function loadKey(newkey) {
        console.log("loadKey: " + newkey);

        //save private key only!
        if (newkey[0] == "-") {
            console.log("new key = " + newkey);
            localStorage.setItem("unusedKey", newkey);
        }
        var key = screenPoll.key = newkey;

        if (!screenPoll.json) {
            console.log("verbose: not json on key: " + key + " yet");
            return;
        }
        saveLocally(key, screenPoll.json);
    }

</script>

<!-- GOOGLE STARS ? -->
<!--http://www.webpagefx.com/blog/seo/how-to-get-stars-search/-->
<!--<div itemscope itemtype=”http://schema.org/Product”>
    <img itemprop=”image” src=”image-link.jpg” alt="Product Name"/>
    <span itemprop=”name”>Product Name</span>
    <div itemprop=”aggregateRating itemscope itemtype=”http://schema.org/AggregateRating”>
        <span itemprop=”ratingValue”>4.5</span>
        out of <span itemprop=”bestRating”>5</span>
        based on <span itemprop=”ratingCount”>301</span> user ratings.
    </div>
</div>-->
